name: dist

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: registry.fedoraproject.org/fedora:latest
    steps:
      - run: dnf install --setopt install_weak_deps=False --assumeyes golang git-core meson 'pkgconfig(bash-completion)' 'pkgconfig(yggdrasil)' 'pkgconfig(dbus-1)' 'pkgconfig(systemd)' 'rpm_macro(forgemeta)'
      - uses: actions/checkout@v4
      # See https://github.com/mesonbuild/meson/pull/13637
      - run: git config --global safe.directory "*"
      - run: meson setup -Dvendor=True _build
      - run: meson dist -C _build
      - uses: softprops/action-gh-release@v2
        with:
          files: _build/meson-dist/rhc-*.tar.xz*
